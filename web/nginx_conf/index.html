<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://jacedoe.github.io/server-labs/web/nginx_conf/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>2.1. Intalaci√≥n de Nginx y Hugo - Gu√≠a de Infraestructura Xen, Linux y contenedores</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Gu√≠a de Infraestructura Xen, Linux y contenedores</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">üè° Inicio</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">üîí 1. Preparaci√≥n de la Infraestructura</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../preparacion/instalacion_xo_lite/" class="dropdown-item">1.1. Servidor XCP-ng</a>
</li>
                                    
<li>
    <a href="../../preparacion/instalacion_alpine/" class="dropdown-item">1.2. Despliegue VM Alpine LInux</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">üîí 2. Despliegue en producci√≥n de sitio web</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">2.1. Intalaci√≥n de Nginx y Hugo</a>
</li>
                                    
<li>
    <a href="../despliegue_stack_web/" class="dropdown-item">2.2. Configuraci√≥n del stack Nginx-MariaDB-WordPress</a>
</li>
                                    
<li>
    <a href="../../seguridad/cloudflare_tunnel/" class="dropdown-item">2.3. Cloudflare Tunnel</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">üìö Ap√©ndices</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../apendices/comandos_utiles/" class="dropdown-item">Comandos √ötiles</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="../../guia-de-estilo.md" class="nav-link">üìò Gu√≠a de Estilo (Oficial)</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../preparacion/instalacion_alpine/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../despliegue_stack_web/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/jacedoe/server-labs/edit/master/docs/web/nginx_conf.md" class="nav-link">Edit on server-labs
                                    </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#reiniciar-nginx-tras-cambios-en-la-config" class="nav-link">Reiniciar Nginx tras cambios en la config</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#verificar-que-el-socket-de-php-fpm-este-activo" class="nav-link">Verificar que el socket de PHP-FPM est√© activo</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#logs-de-error-en-tiempo-real" class="nav-link">Logs de error en tiempo real</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#actualizar-indices-de-paquetes" class="nav-link">Actualizar √≠ndices de paquetes</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#instalar-nginx" class="nav-link">Instalar nginx</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#anadir-nginx-al-inicio-automatico" class="nav-link">A√±adir Nginx al inicio autom√°tico</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#iniciar-el-servicio-por-primera-vez" class="nav-link">Iniciar el servicio por primera vez</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#comprobar-el-estado" class="nav-link">Comprobar el estado</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#asegurate-de-que-el-usuario-nginx-tiene-acceso-a-tus-webs" class="nav-link">Aseg√∫rate de que el usuario nginx tiene acceso a tus webs</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#permisos-recomendados-para-directorios-y-archivos" class="nav-link">Permisos recomendados para directorios y archivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#verificar-sintaxis-esto-te-ahorra-muchos-dolores-de-cabeza" class="nav-link">Verificar sintaxis (esto te ahorra muchos dolores de cabeza)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#si-el-test-es-exitoso-recarga-sin-cortar-conexiones-activas" class="nav-link">Si el test es exitoso, recarga sin cortar conexiones activas</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p>üåê Arquitectura de Servidor: Merce Pons</p>
<p>Esta secci√≥n documenta la implementaci√≥n nativa en Alpine Linux para la infraestructura de la escritora Merce Pons.
Esquema de Flujo de Datos
1. Configuraci√≥n de Nginx</p>
<p>La configuraci√≥n se divide en dos bloques l√≥gicos para optimizar el rendimiento y la seguridad.
A. Sitio Principal (Hugo - Est√°tico)</p>
<pre><code>Puerto: 8080 (Configurado para recibir tr√°fico del T√∫nel de Cloudflare).

Directorio ra√≠z: /var/www/mercepons/public.

Estrategia: Entrega directa de archivos con fallback 404. Al ser Hugo, no requiere procesamiento de lenguaje de lado del servidor, lo que garantiza una carga instant√°nea.
</code></pre>
<p>B. Blog (WordPress - Din√°mico)</p>
<pre><code>Puerto: 80.

Procesamiento PHP: Se utiliza PHP-FPM 8.4 a trav√©s de un socket Unix (/var/run/php-fpm84.sock), lo cual es m√°s eficiente que TCP en instalaciones nativas de Alpine.

Par√°metros Cr√≠ticos de Proxy: * fastcgi_param HTTPS on;: Crucial para evitar bucles de redirecci√≥n (Mixed Content) ya que SSL termina en Cloudflare.

    HTTP_X_FORWARDED_PROTO: Permite que WordPress reconozca que el usuario final navega de forma segura.
</code></pre>
<ol>
<li>Manual de Mantenimiento (SysAdmin)
Gesti√≥n de Servicios en Alpine (OpenRC)</li>
</ol>
<p>Para reiniciar o aplicar cambios en la configuraci√≥n:
Bash</p>
<h1 id="reiniciar-nginx-tras-cambios-en-la-config">Reiniciar Nginx tras cambios en la config<a class="headerlink" href="#reiniciar-nginx-tras-cambios-en-la-config" title="Permanent link">&para;</a></h1>
<p>rc-service nginx restart</p>
<h1 id="verificar-que-el-socket-de-php-fpm-este-activo">Verificar que el socket de PHP-FPM est√© activo<a class="headerlink" href="#verificar-que-el-socket-de-php-fpm-este-activo" title="Permanent link">&para;</a></h1>
<p>ls -l /var/run/php-fpm84.sock</p>
<h1 id="logs-de-error-en-tiempo-real">Logs de error en tiempo real<a class="headerlink" href="#logs-de-error-en-tiempo-real" title="Permanent link">&para;</a></h1>
<p>tail -f /var/log/nginx/error.log</p>
<p>Despliegue de Actualizaciones</p>
<pre><code>Hugo: Al ejecutar hugo en tu entorno de desarrollo, el contenido se sincroniza con /var/www/mercepons/public.

WordPress: El n√∫cleo y plugins se mantienen mediante el panel o wp-cli nativo en Alpine.
</code></pre>
<ol>
<li>
<p>Optimizaciones Implementadas</p>
<p>Cach√© Agresiva: Se ha configurado un tiempo de expiraci√≥n m√°ximo (expires max) para archivos est√°ticos (js, css, im√°genes), reduciendo la latencia y el ancho de banda del servidor.</p>
<p>Seguridad: Bloqueo expl√≠cito de archivos .htaccess y archivos ocultos, reduciendo la superficie de ataque.</p>
<p>Silencio de Logs: Se desactivan los logs para favicon.ico y robots.txt para evitar el llenado innecesario de archivos de log.</p>
</li>
</ol>
<p>üõ†Ô∏è Paso 1: Instalaci√≥n del paquete</p>
<p>Como Alpine es minimalista, primero aseg√∫rate de tener los repositorios actualizados.
Bash</p>
<h1 id="actualizar-indices-de-paquetes">Actualizar √≠ndices de paquetes<a class="headerlink" href="#actualizar-indices-de-paquetes" title="Permanent link">&para;</a></h1>
<p>apk update</p>
<h1 id="instalar-nginx">Instalar nginx<a class="headerlink" href="#instalar-nginx" title="Permanent link">&para;</a></h1>
<p>apk add nginx</p>
<p>‚öôÔ∏è Paso 2: Gesti√≥n del Servicio (OpenRC)</p>
<p>Alpine no usa systemd, usa OpenRC. Estos son los comandos que necesitas para que Nginx arranque siempre con el servidor:
Bash</p>
<h1 id="anadir-nginx-al-inicio-automatico">A√±adir Nginx al inicio autom√°tico<a class="headerlink" href="#anadir-nginx-al-inicio-automatico" title="Permanent link">&para;</a></h1>
<p>rc-update add nginx default</p>
<h1 id="iniciar-el-servicio-por-primera-vez">Iniciar el servicio por primera vez<a class="headerlink" href="#iniciar-el-servicio-por-primera-vez" title="Permanent link">&para;</a></h1>
<p>rc-service nginx start</p>
<h1 id="comprobar-el-estado">Comprobar el estado<a class="headerlink" href="#comprobar-el-estado" title="Permanent link">&para;</a></h1>
<p>rc-service nginx status</p>
<p>üìÇ Paso 3: Estructura de archivos en Alpine</p>
<p>A diferencia de Debian/Ubuntu, Alpine organiza los archivos de forma ligeramente distinta:</p>
<pre><code>Configuraci√≥n principal: /etc/nginx/nginx.conf

Configuraciones de sitios: /etc/nginx/http.d/ (Aqu√≠ es donde debes crear tus archivos .conf como el de Merce Pons).

Logs: /var/log/nginx/

Directorio web por defecto: /var/lib/nginx/html (Aunque t√∫ est√°s usando /var/www/).
</code></pre>
<p>üë§ Paso 4: Usuarios y Permisos</p>
<p>Nginx en Alpine corre bajo el usuario nginx por defecto. Para que pueda leer tus carpetas de Hugo y WordPress:
Bash</p>
<h1 id="asegurate-de-que-el-usuario-nginx-tiene-acceso-a-tus-webs">Aseg√∫rate de que el usuario nginx tiene acceso a tus webs<a class="headerlink" href="#asegurate-de-que-el-usuario-nginx-tiene-acceso-a-tus-webs" title="Permanent link">&para;</a></h1>
<p>chown -R nginx:nginx /var/www/mercepons
chown -R nginx:nginx /var/www/blog</p>
<h1 id="permisos-recomendados-para-directorios-y-archivos">Permisos recomendados para directorios y archivos<a class="headerlink" href="#permisos-recomendados-para-directorios-y-archivos" title="Permanent link">&para;</a></h1>
<p>find /var/www/ -type d -exec chmod 755 {} \;
find /var/www/ -type f -exec chmod 644 {} \;</p>
<p>üöÄ Paso 5: Verificaci√≥n y Carga</p>
<p>Cada vez que edites tu configuraci√≥n (como el archivo que me pasaste antes), nunca reinicies sin probar primero:
Bash</p>
<h1 id="verificar-sintaxis-esto-te-ahorra-muchos-dolores-de-cabeza">Verificar sintaxis (esto te ahorra muchos dolores de cabeza)<a class="headerlink" href="#verificar-sintaxis-esto-te-ahorra-muchos-dolores-de-cabeza" title="Permanent link">&para;</a></h1>
<p>nginx -t</p>
<h1 id="si-el-test-es-exitoso-recarga-sin-cortar-conexiones-activas">Si el test es exitoso, recarga sin cortar conexiones activas<a class="headerlink" href="#si-el-test-es-exitoso-recarga-sin-cortar-conexiones-activas" title="Permanent link">&para;</a></h1>
<p>nginx -s reload</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
